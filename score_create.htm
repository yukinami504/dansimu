<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport">
  <title>譜面追加用</title>
  
</head>
<body>
  <header>
	<h2 class="headline">
      <span>譜面追加用</span>
    </h2>
  </header>
  
  <form name="infoForm">
	<h3>読み込み</h3>
	<textarea name="example" id="ta1" rows="4" cols="40"></textarea>
	<button type="button" onclick="parse()">変換</button>
	<h3>JSONtext</h3>
	<textarea name="example" id="ta2" rows="4" cols="40"></textarea>
	<p id="txt1">読み込んでください</p>
	<table name="extable" id="tb1">
		<tr> <td>Bar</td> <td>Ticks</td> <td>notes</td> </tr>
	</table>
	<pre>
	使い方：
	1.読み込む
	2.[変換]を押して変換
	</pre>
  </form>
  <footer>
    <div class="container">
      <p>願わくは 花の下にて 春死なむ その如月の 望月のころ</p>
      <p>(c) 2021 yukinami</p>
    </div>
  </footer>
</body>
</html>

<script>

function parse()
{
	//ret_data
	let scoredata = [];
	let input_score = false;
	let command = null;
	let sub_command = null;
	let note_num = 0;
	let bar_num = 0;
	let ticks = 1920;
	
	//input
	let msg = document.getElementById('ta1').value;
	let tableid = document.getElementById('tb1');
	//console.log(tableid);
	
	let textArray = msg.split('\n');
	let num = textArray.length;
	let sentence="";
	console.log(num);
	for(let i=0;i<num;i++)
	{
		sentence += textArray[i];
		if(sentence[0]=='@')
		{
			command = sentence.slice(1).split(' ')[0];
			subcommand = sentence.slice(1).split(' ')[1];
			if(command =="Start")input_score = true;
			else if(command =="End")input_score = false;
			else if(command =="Bar"){
				let time_nume = subcommand.split('/')[0];
				let time_deno = subcommand.split('/')[1];
				ticks = 1920*parseInt(time_nume)/parseInt(time_deno);
			}
			sentence="";
		}
		else 
		{
			console.log(i,sentence);
			if(input_score && sentence.indexOf(',') != -1)
			{
				let score_bar = sentence.split(',')[0];
				let bar_length = score_bar.length;
				bar_num++;
				for(let j=0;j<bar_length;j++)
				{
					let tick = ticks*j/bar_length;
					for(let k=0;k<score_bar[j];k++)
					{
						note_num++;
						console.log(note_num,bar_num,tick);
						scoredata.push({id:note_num,flag:0,bar:bar_num,tick:tick,ms:0});
					}
				}
				//	表に追加
				let newRow = tableid.insertRow();
				let newCell = newRow.insertCell();
				let newText = document.createTextNode(bar_num);
				newCell.appendChild(newText);
				
				newCell = newRow.insertCell();
				newText = document.createTextNode(ticks);
				newCell.appendChild(newText);
				
				newCell = newRow.insertCell();
				newText = document.createTextNode(note_num);
				newCell.appendChild(newText);
				
				sentence="";
			}
		}
		
	}
	out_text = JSON.stringify(scoredata);
	
	
	//output
	//document.getElementById('ta2').value = msg;
	document.getElementById('ta2').value = out_text;
	
	
}


</script>